version: '3'

services:
    ci:
        build: ./ci
        depends_on:
            - node1
            - node2
            - node3
            - node4
        volumes:
            - ./ci/tests:/tests
        tty: true
        working_dir: /tests
        hostname: ci
        extra_hosts:
            # haproxy bindings
            - "service.cluster.lab:10.10.77.64"
            - "service.qualif.cluster:10.10.77.64"
        networks:
            cluster_nodes:

    node1:
        build:
            context: .
            args:
                # from env
                - DOCKER_GROUP_ID
        ports:
            #- "5001:2375"
            - "8501:8500"
            - "81:80"
        volumes:
            - /mnt/btrfs1:/var/lib/buttervolume
            - ./..:/cluster  # important: /cluster directory to have project name prefix as 'cluster'
        privileged: true
        tty: true
        working_dir: /cluster
        hostname: node1
        extra_hosts:
            # haproxy bindings
            - "service.cluster.lab:10.10.77.64"
            - "service.qualif.cluster:10.10.77.64"
        networks:
            cluster_nodes:
                # eth0
                ipv4_address: 10.10.77.61

    node2:
        build:
            context: .
            args:
                # from env
                - DOCKER_GROUP_ID
        ports:
            #- "5002:2375"
            - "8502:8500"
            - "82:80"
        volumes:
            - /mnt/btrfs2:/var/lib/buttervolume
            - ./..:/cluster  # important: /cluster directory to have project name prefix as 'cluster'
        privileged: true
        tty: true
        working_dir: /cluster
        hostname: node2
        extra_hosts:
            # haproxy bindings
            - "service.cluster.lab:10.10.77.64"
            - "service.qualif.cluster:10.10.77.64"
        networks:
            cluster_nodes:
                # eth0
                ipv4_address: 10.10.77.62

    node3:
        build:
            context: .
            args:
                # from env
                - DOCKER_GROUP_ID
        ports:
            #- "5003:2375"
            - "8503:8500"
            - "83:80"
        volumes:
            - /mnt/btrfs3:/var/lib/buttervolume
            - ./..:/cluster  # important: /cluster directory to have project name prefix as 'cluster'
        privileged: true
        tty: true
        working_dir: /cluster
        hostname: node3
        extra_hosts:
            # haproxy bindings
            - "service.cluster.lab:10.10.77.64"
            - "service.qualif.cluster:10.10.77.64"
        networks:
            cluster_nodes:
                # eth0
                ipv4_address: 10.10.77.63

    node4:
        build:
            context: .
            args:
                # from env
                - DOCKER_GROUP_ID
        ports:
            #- "5004:2375"
            - "8504:8500"
            - "84:80"
        volumes:
            - /mnt/btrfs4:/var/lib/buttervolume
            - ./..:/cluster  # important: /cluster directory to have project name prefix as 'cluster'
        privileged: true
        tty: true
        working_dir: /cluster
        hostname: node4
        extra_hosts:
            # haproxy bindings (this)
            - "service.cluster.lab:10.10.77.64"
            - "service.qualif.cluster:10.10.77.64"
        networks:
            cluster_nodes:
                # eth0
                ipv4_address: 10.10.77.64

networks:
    cluster_nodes:
        ipam:
            config:
                - subnet: 10.10.77.0/24
